From a330f7321a4b6442c37a15aabb576a023935982d Mon Sep 17 00:00:00 2001
From: Daniel <danielkaes82@googlemail.com>
Date: Tue, 19 Mar 2013 18:21:39 +0100
Subject: [PATCH 2/2] hibernate: made blog entry storage work with SQL

---
 .../example/springmvc/model/blog/BlogEntry.java    | 14 ++++++-
 .../model/blog/impl/BlogEntryStorageSQLImpl.java   | 44 ++++++++++++++++++++++
 .../java/example/springmvc/model/users/User.java   |  2 +-
 src/main/webapp/WEB-INF/application-context.xml    |  5 ++-
 4 files changed, 62 insertions(+), 3 deletions(-)
 create mode 100644 src/main/java/example/springmvc/model/blog/impl/BlogEntryStorageSQLImpl.java

diff --git a/src/main/java/example/springmvc/model/blog/BlogEntry.java b/src/main/java/example/springmvc/model/blog/BlogEntry.java
index ec30f49..8b7f0d8 100644
--- a/src/main/java/example/springmvc/model/blog/BlogEntry.java
+++ b/src/main/java/example/springmvc/model/blog/BlogEntry.java
@@ -4,20 +4,32 @@ import java.util.Date;
 import java.util.LinkedList;
 import java.util.List;
 
-import example.springmvc.model.users.User;
+import javax.persistence.Column;
+import javax.persistence.Entity;
+import javax.persistence.Id;
+import javax.persistence.Table;
 
+import example.springmvc.model.users.User;
 
 
+@Entity
+@Table(name="blogentry_table", catalog="test")
 public class BlogEntry {
 	
+	@Id
+	@Column(name="id")
 	private String id = "";
 	
+	@Column(name="text")
 	private String text = "";
 	
+	@Column(name="authorid")
 	private String authorId = "";
 	
+	@Column(name="creation_date")
 	private Date creationDate = new Date();
 	
+	//TODO: map the tags properly
 	private List<String> tags = new LinkedList<String>();
 	
 	public BlogEntry() {
diff --git a/src/main/java/example/springmvc/model/blog/impl/BlogEntryStorageSQLImpl.java b/src/main/java/example/springmvc/model/blog/impl/BlogEntryStorageSQLImpl.java
new file mode 100644
index 0000000..1bae573
--- /dev/null
+++ b/src/main/java/example/springmvc/model/blog/impl/BlogEntryStorageSQLImpl.java
@@ -0,0 +1,44 @@
+package example.springmvc.model.blog.impl;
+
+import java.util.List;
+
+import org.hibernate.Session;
+import org.hibernate.SessionFactory;
+import org.springframework.beans.factory.annotation.Autowired;
+
+import example.springmvc.model.blog.BlogEntry;
+import example.springmvc.model.blog.BlogEntryStorage;
+
+public class BlogEntryStorageSQLImpl implements BlogEntryStorage {
+	
+	@Autowired
+	private SessionFactory sessionFactory;
+
+	@Override
+	public BlogEntry byId(String id) {
+		Session session = this.sessionFactory.getCurrentSession();
+		session.beginTransaction();
+		BlogEntry entry = (BlogEntry) session.get(BlogEntry.class, id);
+		session.getTransaction().commit();
+		return entry;
+	}
+
+	@Override
+	public void saveOrUpdate(BlogEntry entry) {
+		Session session = this.sessionFactory.getCurrentSession();
+		session.beginTransaction();
+		session.saveOrUpdate(entry);
+		session.getTransaction().commit();
+	}
+
+	@Override
+	public List<BlogEntry> findAll() {
+		Session session = this.sessionFactory.getCurrentSession();
+		session.beginTransaction();
+		@SuppressWarnings("unchecked")
+		List<BlogEntry> list = session.createQuery("from blogentry_table").list();
+		session.getTransaction().commit();
+		return list;
+	}
+
+}
diff --git a/src/main/java/example/springmvc/model/users/User.java b/src/main/java/example/springmvc/model/users/User.java
index 852f775..c25505a 100644
--- a/src/main/java/example/springmvc/model/users/User.java
+++ b/src/main/java/example/springmvc/model/users/User.java
@@ -12,7 +12,7 @@ import javax.persistence.Table;
  *
  */
 @Entity
-@Table(name="tuser")
+@Table(name="user_table", catalog="test")
 public class User {
 	
 	public User(){}
diff --git a/src/main/webapp/WEB-INF/application-context.xml b/src/main/webapp/WEB-INF/application-context.xml
index 157ee03..87276fd 100644
--- a/src/main/webapp/WEB-INF/application-context.xml
+++ b/src/main/webapp/WEB-INF/application-context.xml
@@ -17,8 +17,9 @@
 		http://www.springframework.org/schema/jee/spring-jee-3.0.xsd">
 
 	<bean id="userService" class="example.springmvc.model.users.UserService"></bean>
+	
 	<!-- <bean id="userStorage" class="example.springmvc.model.users.impl.UserStorageDummyImpl"></bean>  -->
-	<bean id="blogEntryStorage" class="example.springmvc.model.blog.impl.BlogEntryStorageDummyImpl"></bean>
+	<!-- <bean id="blogEntryStorage" class="example.springmvc.model.blog.impl.BlogEntryStorageDummyImpl"></bean> -->
 	
 	<!-- replace the previous with the next line to use the MongoDB storage implementation  -->
 	<!--    
@@ -27,6 +28,7 @@
 	-->
 	
 	<bean id="userStorage" class="example.springmvc.model.users.impl.UserStorageSQLImpl"></bean>
+	<bean id="blogEntryStorage" class="example.springmvc.model.blog.impl.BlogEntryStorageSQLImpl"></bean>
 
 	<!-- Hibernate -->
 	<jee:jndi-lookup id="jndiDataSource" jndi-name="jdbc/mysql"></jee:jndi-lookup>
@@ -44,6 +46,7 @@
 		<property name="annotatedClasses">
 			<list>
 				<value>example.springmvc.model.users.User</value>
+				<value>example.springmvc.model.blog.BlogEntry</value>
 			</list>
 		</property>
 		<property name="hibernateProperties">
-- 
1.8.0.msysgit.0

