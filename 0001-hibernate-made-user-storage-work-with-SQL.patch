From 9f58a4df0d1b44c3342806965634de33f0b9dfcf Mon Sep 17 00:00:00 2001
From: Daniel <danielkaes82@googlemail.com>
Date: Tue, 19 Mar 2013 17:50:00 +0100
Subject: [PATCH 1/2] hibernate: made user storage work with SQL

---
 .../java/example/springmvc/model/users/User.java   |  3 +++
 .../model/users/impl/UserStorageSQLImpl.java       |  1 -
 src/main/webapp/WEB-INF/application-context.xml    | 30 ++++++++++++++--------
 src/main/webapp/WEB-INF/web.xml                    |  8 ++++++
 4 files changed, 31 insertions(+), 11 deletions(-)

diff --git a/src/main/java/example/springmvc/model/users/User.java b/src/main/java/example/springmvc/model/users/User.java
index e4ade9b..852f775 100644
--- a/src/main/java/example/springmvc/model/users/User.java
+++ b/src/main/java/example/springmvc/model/users/User.java
@@ -14,6 +14,9 @@ import javax.persistence.Table;
 @Entity
 @Table(name="tuser")
 public class User {
+	
+	public User(){}
+	
 	@Id
 	@Column(name="id")
 	private String id = "";
diff --git a/src/main/java/example/springmvc/model/users/impl/UserStorageSQLImpl.java b/src/main/java/example/springmvc/model/users/impl/UserStorageSQLImpl.java
index 10b082c..99e60af 100644
--- a/src/main/java/example/springmvc/model/users/impl/UserStorageSQLImpl.java
+++ b/src/main/java/example/springmvc/model/users/impl/UserStorageSQLImpl.java
@@ -28,5 +28,4 @@ public class UserStorageSQLImpl implements UserStorage {
 		session.saveOrUpdate(user);
 		session.getTransaction().commit();
 	}
-
 }
diff --git a/src/main/webapp/WEB-INF/application-context.xml b/src/main/webapp/WEB-INF/application-context.xml
index d70c3e9..157ee03 100644
--- a/src/main/webapp/WEB-INF/application-context.xml
+++ b/src/main/webapp/WEB-INF/application-context.xml
@@ -3,18 +3,21 @@
 	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 	xmlns:aop="http://www.springframework.org/schema/aop"
     xmlns:tx="http://www.springframework.org/schema/tx"
+    xmlns:jee="http://www.springframework.org/schema/jee"
 	xsi:schemaLocation="
-        http://www.springframework.org/schema/beans     
+        http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
-        http://www.springframework.org/schema/context 
+        http://www.springframework.org/schema/context
         http://www.springframework.org/schema/context/spring-context-3.0.xsd
-        http://www.springframework.org/schema/tx 
+        http://www.springframework.org/schema/tx
 		http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
-		http://www.springframework.org/schema/aop 
-		http://www.springframework.org/schema/aop/spring-aop-3.0.xsd">
+		http://www.springframework.org/schema/aop
+		http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
+		http://www.springframework.org/schema/jee
+		http://www.springframework.org/schema/jee/spring-jee-3.0.xsd">
 
 	<bean id="userService" class="example.springmvc.model.users.UserService"></bean>
-	<!--<bean id="userStorage" class="example.springmvc.model.users.impl.UserStorageDummyImpl"></bean> -->
+	<!-- <bean id="userStorage" class="example.springmvc.model.users.impl.UserStorageDummyImpl"></bean>  -->
 	<bean id="blogEntryStorage" class="example.springmvc.model.blog.impl.BlogEntryStorageDummyImpl"></bean>
 	
 	<!-- replace the previous with the next line to use the MongoDB storage implementation  -->
@@ -26,22 +29,29 @@
 	<bean id="userStorage" class="example.springmvc.model.users.impl.UserStorageSQLImpl"></bean>
 
 	<!-- Hibernate -->
+	<jee:jndi-lookup id="jndiDataSource" jndi-name="jdbc/mysql"></jee:jndi-lookup>
+	
 	<bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
 		<property name="driverClassName" value="org.mysql.jdbc.Driver" />
 		<property name="url" value="jdbc:mysql://localhost/test" />
 		<property name="username" value="root" />
-		<property name="password" value="asdw23" />
+		<property name="password" value="system" />
 	</bean>
 
 	<bean id="sessionFactory"
-		class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">
-		<property name="dataSource" ref="dataSource" />
-		<!-- <property name="configurationClass" value="org.hibernate.cfg.AnnotationConfiguration" /> -->
+			class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">
+		<property name="dataSource" ref="jndiDataSource" />
+		<property name="annotatedClasses">
+			<list>
+				<value>example.springmvc.model.users.User</value>
+			</list>
+		</property>
 		<property name="hibernateProperties">
 			<props>
 				<prop key="hibernate.show_sql">true</prop>
 				<prop key="hibernate.dialect">org.hibernate.dialect.MySQL5Dialect</prop>
 				<prop key="hibernate.current_session_context_class">thread</prop>
+				<prop key="hibernate.hbm2ddl.auto">create-drop</prop>
 			</props>
 		</property>
 	</bean>
diff --git a/src/main/webapp/WEB-INF/web.xml b/src/main/webapp/WEB-INF/web.xml
index b8ccc3c..63fce63 100644
--- a/src/main/webapp/WEB-INF/web.xml
+++ b/src/main/webapp/WEB-INF/web.xml
@@ -74,4 +74,12 @@
 		<url-pattern>/*</url-pattern>
 	</filter-mapping>
 	
+	<!-- Database -->
+	<resource-ref>
+		<description>Local MySQL database</description>
+		<res-ref-name>jdbc/mysql</res-ref-name>
+		<res-type>javax.sql.DataSource</res-type>
+		<res-auth>Container</res-auth>
+	</resource-ref>
+	
 </web-app>
\ No newline at end of file
-- 
1.8.0.msysgit.0

